<!doctype html>
<meta charset="utf-8">
<title>Player</title>
<style>video{width:60%;background:#000}</style>
<h3>è§‚çœ‹ç«¯ï¼ˆä»æœåŠ¡å™¨æ‹‰æµï¼‰</h3>
<button id="play">å¼€å§‹æ’­æ”¾</button>
<button id="stop" disabled>åœæ­¢</button>
<div><video id="remote" autoplay playsinline controls></video></div>
<script>
  // å»ºç«‹ WebSocket è¿æ¥
const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${wsProto}://${location.host}/ws`);

let pc, heartbeat;
let statsTimerSub, lastBytesSub = 0, lastTimestampSub = Date.now();

// å¿ƒè·³ï¼šå®šæœŸå‘é€ ping ä¿æŒè¿æ¥
ws.onopen = () => {
  heartbeat = setInterval(() => {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({id: "ping"}));
      console.log(`[Heartbeat] ping sent at ${new Date().toLocaleTimeString()}`);
    }
  }, 30000);
};

// WebSocket å…³é—­æ—¶æ¸…ç†å¿ƒè·³
ws.onclose = () => {
  clearInterval(heartbeat);
};

// æ¥æ”¶æœåŠ¡å™¨æ¶ˆæ¯
ws.onmessage = async (e) => { // å½“WebSocket ä»æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šè§¦å‘ ws.onmessage
  const msg = JSON.parse(e.data);
  if (msg.id === 'playResponse') { // æœåŠ¡å™¨è¿”å›SDP answer ,è®¾ç½®ä¸ºè¿œç«¯æè¿°ï¼Œå®Œæˆåå•†
    await pc.setRemoteDescription(new RTCSessionDescription({type:'answer', sdp: msg.sdpAnswer}));
  } else if (msg.id === 'iceCandidate') { // æœåŠ¡å™¨è½¬å‘çš„å¯¹ç«¯å€™é€‰åœ°å€ï¼ŒåŠ å…¥åˆ°æœ¬åœ°è¿æ¥
    try { await pc.addIceCandidate(msg.candidate); } catch (err) { console.warn(err); }
  } else if (msg.id === 'error') {
    alert('Server error: ' + msg.message);
  } else if (msg.id === 'pong') {  // å¯¹å‰ç«¯å®šæœŸå‘çš„ "ping" çš„å›åº”
    console.log(`[Heartbeat] pong received at ${new Date().toLocaleTimeString()}`);
  }
};


// ---------- stats ç›‘æ§é€»è¾‘ï¼ˆæ‹‰æµç«¯ï¼‰ ----------
function startStatsMonitorPlayer() {
  if (statsTimerSub) clearInterval(statsTimerSub);
  lastBytesSub = 0;
  lastTimestampSub = Date.now();

  statsTimerSub = setInterval(async () => {
    if (!pc) return;
    const stats = await pc.getStats();
    stats.forEach(report => {
      if (report.type === "inbound-rtp" && report.kind === "video") {
        const now = Date.now();
        if (lastBytesSub > 0) {
          const bitrate = ((report.bytesReceived - lastBytesSub) * 8) / ((now - lastTimestampSub) / 1000);
          console.log(`[${new Date().toLocaleTimeString()}] ğŸ¬ æ‹‰æµç«¯ç ç‡: ${(bitrate/1000).toFixed(2)} kbps`);
        }
        lastBytesSub = report.bytesReceived;
        lastTimestampSub = now;

        // æ‰“å°åˆ†è¾¨ç‡
        const track = document.getElementById('remote').srcObject?.getVideoTracks()[0];
        if (track) {
          const settings = track.getSettings();
          console.log(`[${new Date().toLocaleTimeString()}] ğŸ“º åˆ†è¾¨ç‡: ${settings.width}x${settings.height}, fpsâ‰ˆ${settings.frameRate || "?"}`);
        }
      }
    });
  }, 5000);
}

function stopStatsMonitorPlayer() {
  if (statsTimerSub) clearInterval(statsTimerSub);
  statsTimerSub = null;
}

// æ’­æ”¾è§†é¢‘é€»è¾‘
async function play() {
  // ç¦ç”¨ å¯åŠ¨æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
  document.getElementById('play').disabled = true;
  document.getElementById('stop').disabled = false;

  // åˆ›å»º RTCPeerConnection ,,æŒ‡å®šSTUNæœåŠ¡å™¨ï¼Œå¸®åŠ©NATç©¿é€
  pc = new RTCPeerConnection({
    iceServers:[{urls:'stun:stun.l.google.com:19302'}]
  });

  // å‡è®¾ä½ å·²ç»åˆ›å»ºäº† RTCPeerConnection å¯¹è±¡ pc
  pc.addEventListener('iceconnectionstatechange', () => {
    const state = pc.iceConnectionState;
    const now = new Date().toLocaleTimeString();

    console.log(`[${now}] ICE connection state changed: ${state}`);

    // å¦‚æœè¿æ¥æ–­å¼€ï¼Œé¢å¤–æç¤ºä¸€ä¸‹
    if (state === 'disconnected' || state === 'failed') {
      console.warn(`[${now}] âš ï¸ ICE è¿æ¥æ–­å¼€ï¼å¯èƒ½æ— æ³•ç»§ç»­æ‹‰æµ/æ¨æµ`);
    }
  });

  // ? å°†æ”¶é›†åˆ°æœ¬åœ°çš„å€™é€‰åœ°å€ï¼Œé€šè¿‡WebSocketå‘ç»™æœåŠ¡å™¨
  pc.onicecandidate = ev => {
    if (ev.candidate) ws.send(JSON.stringify({id:'onIceCandidate', candidate: ev.candidate}));
  };
  // ä¸€æ—¦æ”¶åˆ°è¿œæµç«¯ï¼Œå°†å…¶ç»‘å®šåˆ°<video id="remoto">æ’­æ”¾
  pc.ontrack = ev => { 
    document.getElementById('remote').srcObject = ev.streams[0]; 
    // å¯åŠ¨ stats ç›‘æ§ï¼ˆæ¯ 30 ç§’æ‰“å°ä¸€æ¬¡ï¼‰
    startStatsMonitorPlayer();
  };

  

  // ä»…æ¥æ”¶ï¼šæ·»åŠ  recvonly è½¬æ¥æ”¶åª’ä½“
  pc.addTransceiver('video', {direction:'recvonly'});
  pc.addTransceiver('audio', {direction:'recvonly'});

  // ç”Ÿæˆ SDP offer å¹¶ä¿å­˜ä¸ºæœ¬åœ°æè¿°
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // æŠŠplayè¯·æ±‚å’ŒSDP offer å‘é€ç»™æœåŠ¡å™¨ï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å›answer
  ws.send(JSON.stringify({id:'play', sdpOffer: offer.sdp}));
}

// åœæ­¢æ’­æ”¾
function stop() {
  ws.send(JSON.stringify({id:'stop'}));
  if (pc) pc.close();
  pc = null;
  document.getElementById('play').disabled = false;
  document.getElementById('stop').disabled = true;
  stopStatsMonitorPlayer();// åœæ­¢statsç›‘æµ‹
}

// // ---------- stats ç›‘æ§é€»è¾‘ ----------
// let statsTimer;
// let lastBytes = 0;
// let lastTimestamp = Date.now();

// function startStatsMonitor() {
//   if (statsTimer) clearInterval(statsTimer);

//   statsTimer = setInterval(async () => {
//     if (!pc) return;
//     const stats = await pc.getStats();
//     stats.forEach(report => {
//       // åªå…³å¿ƒ inbound-rtpï¼ˆæ¥æ”¶ç«¯ï¼‰
//       if (report.type === "inbound-rtp" && report.kind === "video") {
//         const now = Date.now();
//         const nowTime = new Date().toLocaleTimeString();

//         // è®¡ç®—ç¬æ—¶ç ç‡ï¼ˆbps â†’ kbpsï¼‰
//         if (lastBytes > 0) {
//           const bitrate = ((report.bytesReceived - lastBytes) * 8) / ((now - lastTimestamp) / 1000);
//           console.log(`[${nowTime}] â–¶ ç¬æ—¶è§†é¢‘å¸¦å®½: ${(bitrate/1000).toFixed(2)} kbps`);
//         }

//         lastBytes = report.bytesReceived;
//         lastTimestamp = now;

//         // è·å–åˆ†è¾¨ç‡
//         const track = document.getElementById('remote').srcObject?.getVideoTracks()[0];
//         if (track) {
//           const settings = track.getSettings();
//           console.log(`[${nowTime}] ğŸ“º åˆ†è¾¨ç‡: ${settings.width}x${settings.height}, fpsâ‰ˆ${settings.frameRate || "?"}`);
//         }
//       }
//     });
//   }, 30000); // æ¯ 30 ç§’æ‰“å°ä¸€æ¬¡
// }

// function stopStatsMonitor() {
//   if (statsTimer) clearInterval(statsTimer);
//   statsTimer = null;
// }

// ç»‘å®šæŒ‰é’® play()ä¸å¼€å§‹æ’­æ”¾ stop()ä¸åœæ­¢ç»‘å®š
document.getElementById('play').onclick = play;
document.getElementById('stop').onclick = stop;
</script>
